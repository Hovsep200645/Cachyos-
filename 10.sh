#!/bin/bash
# flash_recovery_only.sh - –ü—Ä–æ—à–∏–≤–∫–∞ —Ç–æ–ª—å–∫–æ —Ä–µ–∫–∞–≤–µ—Ä–∏ –∏ –∑–∞–ø—É—Å–∫

set -e

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

RECOVERY_FILE="recovery.img"

log() {
    echo -e "${GREEN}[$(date +%T)]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_recovery_file() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ —Ä–µ–∫–∞–≤–µ—Ä–∏..."
    
    if [[ ! -f "$RECOVERY_FILE" ]]; then
        error "–§–∞–π–ª $RECOVERY_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        echo "–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ recovery.img –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
    file_size=$(stat -f%z "$RECOVERY_FILE" 2>/dev/null || stat -c%s "$RECOVERY_FILE" 2>/dev/null)
    if [[ $file_size -lt 10000000 ]]; then
        warn "–§–∞–π–ª —Ä–µ–∫–∞–≤–µ—Ä–∏ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π ($file_size bytes) - –≤–æ–∑–º–æ–∂–Ω–æ –±–∏—Ç—ã–π"
    fi
    
    log "‚úÖ –§–∞–π–ª —Ä–µ–∫–∞–≤–µ—Ä–∏ –Ω–∞–π–¥–µ–Ω: $RECOVERY_FILE ($file_size bytes)"
}

detect_device() {
    log "–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—à–∏–≤–∫–∏..."
    
    if sudo heimdall detect; then
        log "‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
        return 0
    else
        error "‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
        echo "–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ä–µ–∂–∏–º–µ –∑–∞–≥—Ä—É–∑–∫–∏:"
        echo "1. –í—ã–∫–ª—é—á–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"
        echo "2. –ó–∞–∂–∞—Ç—å Vol- + Home + Power"
        echo "3. –ü–æ–¥–∫–ª—é—á–∏—Ç—å USB –∫–∞–±–µ–ª—å"
        return 1
    fi
}

flash_recovery_only() {
    log "–ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—à–∏–≤–∫—É —Ä–µ–∫–∞–≤–µ—Ä–∏..."
    
    # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø—Ä–æ—à–∏–≤–∫–∏
    log "–ú–µ—Ç–æ–¥ 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ—à–∏–≤–∫–∞..."
    if sudo heimdall flash --RECOVERY "$RECOVERY_FILE" --no-reboot; then
        log "‚úÖ –†–µ–∫–∞–≤–µ—Ä–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏—Ç"
        return 0
    fi
    
    # –ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –ø—Ä–æ–±—É–µ–º —Å force
    warn "–ú–µ—Ç–æ–¥ 1 –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ—à–∏–≤–∫—É..."
    if sudo heimdall flash --RECOVERY "$RECOVERY_FILE" --no-reboot --force; then
        log "‚úÖ –†–µ–∫–∞–≤–µ—Ä–∏ –ø—Ä–æ—à–∏—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ"
        return 0
    fi
    
    # –ü—Ä–æ–±—É–µ–º —Å verbose –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    warn "–ü—Ä–æ–±—É–µ–º —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º..."
    if sudo heimdall flash --RECOVERY "$RECOVERY_FILE" --no-reboot --verbose; then
        log "‚úÖ –†–µ–∫–∞–≤–µ—Ä–∏ –ø—Ä–æ—à–∏—Ç (verbose mode)"
        return 0
    fi
    
    error "‚ùå –í—Å–µ –º–µ—Ç–æ–¥—ã –ø—Ä–æ—à–∏–≤–∫–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏"
    return 1
}

reboot_to_recovery() {
    log "–ü—ã—Ç–∞—é—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ —Ä–µ–∫–∞–≤–µ—Ä–∏..."
    
    # –ú–µ—Ç–æ–¥ 1: –ß–µ—Ä–µ–∑ heimdall
    if sudo heimdall reboot --recovery; then
        log "‚úÖ –ö–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Ä–µ–∫–∞–≤–µ—Ä–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞"
        return 0
    fi
    
    # –ú–µ—Ç–æ–¥ 2: –ß–µ—Ä–µ–∑ –æ–±—ã—á–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É + –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
    warn "–ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏..."
    if sudo heimdall reboot; then
        log "‚úÖ –ö–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞"
        echo "–°—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∂–º–∏—Ç–µ: Vol+ + Home + Power"
        return 0
    fi
    
    # –ú–µ—Ç–æ–¥ 3: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
    warn "–ü—Ä–æ–±—É–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É..."
    sudo heimdall reboot --force
    log "‚úÖ –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞"
}

wait_for_recovery() {
    log "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Ä–µ–∫–∞–≤–µ—Ä–∏..."
    echo "–ï—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –≤ —Ä–µ–∫–∞–≤–µ—Ä–∏ - —Å–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —É—Å–ø–µ—à–Ω–æ"
    echo "–ñ–¥—É 30 —Å–µ–∫—É–Ω–¥..."
    
    for i in {1..30}; do
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º ADB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ —Ä–µ–∫–∞–≤–µ—Ä–∏
        if adb devices | grep -q "recovery"; then
            log "üéâ –¢–µ–ª–µ—Ñ–æ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –≤ —Ä–µ–∫–∞–≤–µ—Ä–∏!"
            return 0
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
        if lsusb | grep -q "04e8.*recovery\|04e8.*adb"; then
            log "üéâ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ —Ä–µ–∂–∏–º–µ ADB/Recovery!"
            return 0
        fi
        
        echo -n "."
        sleep 1
    done
    
    warn "‚ö†Ô∏è –¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –≤ —Ä–µ–∫–∞–≤–µ—Ä–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥"
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:"
    echo "1. –û—Ç–∫–ª—é—á–∏—Ç—å –∏ –≤–∫–ª—é—á–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"
    echo "2. –ó–∞–∂–∞—Ç—å Vol+ + Home + Power"
    echo "3. –ü–æ–¥–æ–∂–¥–∞—Ç—å 10-15 —Å–µ–∫—É–Ω–¥"
}

emergency_reflash() {
    log "=== –ê–í–ê–†–ò–ô–ù–ê–Ø –ü–†–û–®–ò–í–ö–ê ==="
    warn "–ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –ø—Ä–æ–±—É–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥..."
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π PIT —Ñ–∞–π–ª
    log "–°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π PIT..."
    if sudo heimdall print-pit --output temp.pit; then
        log "PIT —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω, –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—à–∏–≤–∫—É —Å PIT..."
        sudo heimdall flash --RECOVERY "$RECOVERY_FILE" --pit temp.pit --no-reboot
    else
        log "PIT –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º raw –ø—Ä–æ—à–∏–≤–∫—É..."
        sudo heimdall flash --RECOVERY "$RECOVERY_FILE" --raw --no-reboot
    fi
    
    # –û—á–∏—Å—Ç–∫–∞
    rm -f temp.pit
}

main() {
    log "=== –ü—Ä–æ—à–∏–≤–∫–∞ Recovery –¥–ª—è SM-J530FM ==="
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∏
    check_recovery_file
    
    # –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    if ! detect_device; then
        error "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ä–µ–∂–∏–º–µ –∑–∞–≥—Ä—É–∑–∫–∏."
        exit 1
    fi
    
    # –ü—Ä–æ—à–∏–≤–∫–∞ —Ä–µ–∫–∞–≤–µ—Ä–∏
    if flash_recovery_only; then
        log "‚úÖ Recovery —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏—Ç"
    else
        warn "–ü—Ä–æ–±—É–µ–º –∞–≤–∞—Ä–∏–π–Ω—ã–π –º–µ—Ç–æ–¥ –ø—Ä–æ—à–∏–≤–∫–∏..."
        emergency_reflash
    fi
    
    # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
    reboot_to_recovery
    
    # –û–∂–∏–¥–∞–Ω–∏–µ
    wait_for_recovery
    
    log "=== –°–ö–†–ò–ü–¢ –ó–ê–í–ï–†–®–ï–ù ==="
    echo ""
    echo "–ï—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –≤ —Ä–µ–∫–∞–≤–µ—Ä–∏:"
    echo "1. –ú–æ–∂–µ—Ç–µ –ø—Ä–æ—à–∏—Ç—å –ø–æ–ª–Ω—É—é –ø—Ä–æ—à–∏–≤–∫—É"
    echo "2. –°–¥–µ–ª–∞—Ç—å wipe data/factory reset"
    echo "3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é –ø—Ä–æ—à–∏–≤–∫—É"
    echo ""
    echo "–ï—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è:"
    echo "1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª recovery.img"
    echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å USB –∫–∞–±–µ–ª—è"
    echo "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∫–æ–º–ø—å—é—Ç–µ—Ä"
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ Ctrl+C
trap 'echo -e "\n${YELLOW}–°–∫—Ä–∏–ø—Ç –ø—Ä–µ—Ä–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º${NC}"; exit 1' INT

# –ó–∞–ø—É—Å–∫
main "$@"